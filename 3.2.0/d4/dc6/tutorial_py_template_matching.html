<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<title>OpenCV: Template Matching</title>
<link href="../../opencv.ico" rel="shortcut icon" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
//<![CDATA[
MathJax.Hub.Config(
{
  TeX: {
      Macros: {
          matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
          fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
          forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
          vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
          vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
          hdotsfor: ["\\dots", 1],
          mathbbm: ["\\mathbb{#1}", 1],
          bordermatrix: ["\\matrix{#1}", 1]
      }
  }
}
);
//]]>
</script><script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<!--#include virtual="/google-search.html"-->
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenCV
   &#160;<span id="projectnumber">3.2.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<script type="text/javascript">
//<![CDATA[
function getLabelName(innerHTML) {
    var str = innerHTML.toLowerCase();
    // Replace all '+' with 'p'
    str = str.split('+').join('p');
    // Replace all ' ' with '_'
    str = str.split(' ').join('_');
    // Replace all '#' with 'sharp'
    str = str.split('#').join('sharp');
    // Replace other special characters with 'ascii' + code
    for (var i = 0; i < str.length; i++) {
        var charCode = str.charCodeAt(i);
        if (!(charCode == 95 || (charCode > 96 && charCode < 123) || (charCode > 47 && charCode < 58)))
            str = str.substr(0, i) + 'ascii' + charCode + str.substr(i + 1);
    }
    return str;
}
function addToggle() {
    var $getDiv = $('div.newInnerHTML').last();
    var buttonName = $getDiv.html();
    var label = getLabelName(buttonName.trim());
    $getDiv.attr("title", label);
    $getDiv.hide();
    $getDiv = $getDiv.next();
    $getDiv.attr("class", "toggleable_div label_" + label);
    $getDiv.hide();
}
//]]>
</script>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d6/d00/tutorial_py_root.html">OpenCV-Python Tutorials</a></li><li class="navelem"><a class="el" href="../../d2/d96/tutorial_py_table_of_contents_imgproc.html">Image Processing in OpenCV</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Template Matching </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Goals </h2>
<p>In this chapter, you will learn</p><ul>
<li>To find objects in an image using Template Matching</li>
<li>You will see these functions : <b><a class="el" href="../../df/dfb/group__imgproc__object.html#ga586ebfb0a7fb604b35a23d85391329be" title="Compares a template against overlapped image regions. ">cv2.matchTemplate()</a></b>, <b><a class="el" href="../../d2/de8/group__core__array.html#gab473bf2eb6d14ff97e89b355dac20707" title="Finds the global minimum and maximum in an array. ">cv2.minMaxLoc()</a></b></li>
</ul>
<h2>Theory </h2>
<p>Template Matching is a method for searching and finding the location of a template image in a larger image. OpenCV comes with a function <b><a class="el" href="../../df/dfb/group__imgproc__object.html#ga586ebfb0a7fb604b35a23d85391329be" title="Compares a template against overlapped image regions. ">cv2.matchTemplate()</a></b> for this purpose. It simply slides the template image over the input image (as in 2D convolution) and compares the template and patch of input image under the template image. Several comparison methods are implemented in OpenCV. (You can check docs for more details). It returns a grayscale image, where each pixel denotes how much does the neighbourhood of that pixel match with template.</p>
<p>If input image is of size (WxH) and template image is of size (wxh), output image will have a size of (W-w+1, H-h+1). Once you got the result, you can use <b><a class="el" href="../../d2/de8/group__core__array.html#gab473bf2eb6d14ff97e89b355dac20707" title="Finds the global minimum and maximum in an array. ">cv2.minMaxLoc()</a></b> function to find where is the maximum/minimum value. Take it as the top-left corner of rectangle and take (w,h) as width and height of the rectangle. That rectangle is your region of template.</p>
<dl class="section note"><dt>Note</dt><dd>If you are using cv2.TM_SQDIFF as comparison method, minimum value gives the best match.</dd></dl>
<h2>Template Matching in OpenCV </h2>
<p>Here, as an example, we will search for Messi's face in his photo. So I created a template as below:</p>
<div class="image">
<img src="../../messi_face.jpg" alt="messi_face.jpg"/>
<div class="caption">
image</div></div>
<p> We will try all the comparison methods so that we can see how their results look like: </p><div class="fragment"><div class="line"><span class="keyword">import</span> cv2</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line">img = cv2.imread(<span class="stringliteral">&#39;messi5.jpg&#39;</span>,0)</div><div class="line">img2 = img.copy()</div><div class="line">template = cv2.imread(<span class="stringliteral">&#39;template.jpg&#39;</span>,0)</div><div class="line">w, h = template.shape[::-1]</div><div class="line"></div><div class="line"><span class="comment"># All the 6 methods for comparison in a list</span></div><div class="line">methods = [<span class="stringliteral">&#39;cv2.TM_CCOEFF&#39;</span>, <span class="stringliteral">&#39;cv2.TM_CCOEFF_NORMED&#39;</span>, <span class="stringliteral">&#39;cv2.TM_CCORR&#39;</span>,</div><div class="line">            <span class="stringliteral">&#39;cv2.TM_CCORR_NORMED&#39;</span>, <span class="stringliteral">&#39;cv2.TM_SQDIFF&#39;</span>, <span class="stringliteral">&#39;cv2.TM_SQDIFF_NORMED&#39;</span>]</div><div class="line"></div><div class="line"><span class="keywordflow">for</span> meth <span class="keywordflow">in</span> methods:</div><div class="line">    img = img2.copy()</div><div class="line">    method = eval(meth)</div><div class="line"></div><div class="line">    <span class="comment"># Apply template Matching</span></div><div class="line">    res = cv2.matchTemplate(img,template,method)</div><div class="line">    min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(res)</div><div class="line"></div><div class="line">    <span class="comment"># If the method is TM_SQDIFF or TM_SQDIFF_NORMED, take minimum</span></div><div class="line">    <span class="keywordflow">if</span> method <span class="keywordflow">in</span> [cv2.TM_SQDIFF, cv2.TM_SQDIFF_NORMED]:</div><div class="line">        top_left = min_loc</div><div class="line">    <span class="keywordflow">else</span>:</div><div class="line">        top_left = max_loc</div><div class="line">    bottom_right = (top_left[0] + w, top_left[1] + h)</div><div class="line"></div><div class="line">    cv2.rectangle(img,top_left, bottom_right, 255, 2)</div><div class="line"></div><div class="line">    plt.subplot(121),plt.imshow(res,cmap = <span class="stringliteral">&#39;gray&#39;</span>)</div><div class="line">    plt.title(<span class="stringliteral">&#39;Matching Result&#39;</span>), plt.xticks([]), plt.yticks([])</div><div class="line">    plt.subplot(122),plt.imshow(img,cmap = <span class="stringliteral">&#39;gray&#39;</span>)</div><div class="line">    plt.title(<span class="stringliteral">&#39;Detected Point&#39;</span>), plt.xticks([]), plt.yticks([])</div><div class="line">    plt.suptitle(meth)</div><div class="line"></div><div class="line">    plt.show()</div></div><!-- fragment --><p> See the results below:</p>
<ul>
<li>cv2.TM_CCOEFF</li>
</ul>
<div class="image">
<img src="../../template_ccoeff_1.jpg" alt="template_ccoeff_1.jpg"/>
<div class="caption">
image</div></div>
<ul>
<li>cv2.TM_CCOEFF_NORMED</li>
</ul>
<div class="image">
<img src="../../template_ccoeffn_2.jpg" alt="template_ccoeffn_2.jpg"/>
<div class="caption">
image</div></div>
<ul>
<li>cv2.TM_CCORR</li>
</ul>
<div class="image">
<img src="../../template_ccorr_3.jpg" alt="template_ccorr_3.jpg"/>
<div class="caption">
image</div></div>
<ul>
<li>cv2.TM_CCORR_NORMED</li>
</ul>
<div class="image">
<img src="../../template_ccorrn_4.jpg" alt="template_ccorrn_4.jpg"/>
<div class="caption">
image</div></div>
<ul>
<li>cv2.TM_SQDIFF</li>
</ul>
<div class="image">
<img src="../../template_sqdiff_5.jpg" alt="template_sqdiff_5.jpg"/>
<div class="caption">
image</div></div>
<ul>
<li>cv2.TM_SQDIFF_NORMED</li>
</ul>
<div class="image">
<img src="../../template_sqdiffn_6.jpg" alt="template_sqdiffn_6.jpg"/>
<div class="caption">
image</div></div>
<p> You can see that the result using <b>cv2.TM_CCORR</b> is not good as we expected.</p>
<h2>Template Matching with Multiple Objects </h2>
<p>In the previous section, we searched image for Messi's face, which occurs only once in the image. Suppose you are searching for an object which has multiple occurances, <b><a class="el" href="../../d2/de8/group__core__array.html#gab473bf2eb6d14ff97e89b355dac20707" title="Finds the global minimum and maximum in an array. ">cv2.minMaxLoc()</a></b> won't give you all the locations. In that case, we will use thresholding. So in this example, we will use a screenshot of the famous game <b>Mario</b> and we will find the coins in it. </p><div class="fragment"><div class="line"><span class="keyword">import</span> cv2</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</div><div class="line"></div><div class="line">img_rgb = cv2.imread(<span class="stringliteral">&#39;mario.png&#39;</span>)</div><div class="line">img_gray = cv2.cvtColor(img_rgb, cv2.COLOR_BGR2GRAY)</div><div class="line">template = cv2.imread(<span class="stringliteral">&#39;mario_coin.png&#39;</span>,0)</div><div class="line">w, h = template.shape[::-1]</div><div class="line"></div><div class="line">res = cv2.matchTemplate(img_gray,template,cv2.TM_CCOEFF_NORMED)</div><div class="line">threshold = 0.8</div><div class="line">loc = np.where( res &gt;= threshold)</div><div class="line"><span class="keywordflow">for</span> pt <span class="keywordflow">in</span> zip(*loc[::-1]):</div><div class="line">    cv2.rectangle(img_rgb, pt, (pt[0] + w, pt[1] + h), (0,0,255), 2)</div><div class="line"></div><div class="line">cv2.imwrite(<span class="stringliteral">&#39;res.png&#39;</span>,img_rgb)</div></div><!-- fragment --><p> Result:</p>
<div class="image">
<img src="../../res_mario.jpg" alt="res_mario.jpg"/>
<div class="caption">
image</div></div>
 <h2>Additional Resources </h2>
<h2>Exercises </h2>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Dec 23 2016 13:00:25 for OpenCV by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
<script type="text/javascript">
//<![CDATA[
function addButton(label, buttonName) {
    var b = document.createElement("BUTTON");
    b.innerHTML = buttonName;
    b.setAttribute('class', 'toggleable_button label_' + label);
    b.onclick = function() {
        $('.toggleable_button').css({
            border: '2px outset',
            'border-radius': '4px'
        });
        $('.toggleable_button.label_' + label).css({
            border: '2px inset',
            'border-radius': '4px'
        });
        $('.toggleable_div').css('display', 'none');
        $('.toggleable_div.label_' + label).css('display', 'block');
    };
    b.style.border = '2px outset';
    b.style.borderRadius = '4px';
    b.style.margin = '2px';
    return b;
}
function buttonsToAdd($elements, $heading, $type) {
    if ($elements.length === 0) {
        $elements = $("" + $type + ":contains(" + $heading.html() + ")").parent().prev("div.newInnerHTML");
    }
    var arr = jQuery.makeArray($elements);
    var seen = {};
    arr.forEach(function(e) {
        var txt = e.innerHTML;
        if (!seen[txt]) {
            $button = addButton(e.title, txt);
            if (Object.keys(seen).length == 0) {
                var linebreak1 = document.createElement("br");
                var linebreak2 = document.createElement("br");
                ($heading).append(linebreak1);
                ($heading).append(linebreak2);
            }
            ($heading).append($button);
            seen[txt] = true;
        }
    });
    return;
}
$("h2").each(function() {
    $heading = $(this);
    $smallerHeadings = $(this).nextUntil("h2").filter("h3").add($(this).nextUntil("h2").find("h3"));
    if ($smallerHeadings.length) {
        $smallerHeadings.each(function() {
            var $elements = $(this).nextUntil("h3").filter("div.newInnerHTML");
            buttonsToAdd($elements, $(this), "h3");
        });
    } else {
        var $elements = $(this).nextUntil("h2").filter("div.newInnerHTML");
        buttonsToAdd($elements, $heading, "h2");
    }
});
$(".toggleable_button").first().click();
var $clickDefault = $('.toggleable_button.label_python').first();
if ($clickDefault.length) {
    $clickDefault.click();
}
$clickDefault = $('.toggleable_button.label_cpp').first();
if ($clickDefault.length) {
    $clickDefault.click();
}
//]]>
</script>
</body>
</html>
